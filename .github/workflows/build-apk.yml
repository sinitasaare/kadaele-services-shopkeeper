name: Build Android APK

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install dependencies
      run: |
        npm install
        npm install firebase --legacy-peer-deps

    - name: Build web app
      run: npm run build

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Install Capacitor CLI
      run: npm install -g @capacitor/cli

    - name: Add Android Platform
      run: npx cap add android

    - name: Pin Gradle to stable version
      run: |
        sed -i 's|distributionUrl=.*|distributionUrl=https\\://services.gradle.org/distributions/gradle-8.2.1-all.zip|' android/gradle/wrapper/gradle-wrapper.properties
        cat android/gradle/wrapper/gradle-wrapper.properties

    - name: Install ImageMagick
      run: |
        sudo apt-get update
        sudo apt-get install -y --fix-missing --no-install-recommends imagemagick

    - name: Prepare Kadaele icon (resize logo to 1024x1024 for resources)
      run: |
        convert kadaele-logo.png -resize 1024x1024 -background none -gravity center -extent 1024x1024 resources/icon.png
        echo "Icon prepared: $(identify resources/icon.png)"

    - name: Generate all Android icons and splash screens
      run: |
        chmod +x generate-icons.sh
        bash generate-icons.sh

    - name: Sync Capacitor
      run: npx cap sync android

    - name: Cache Gradle
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          gradle-${{ runner.os }}-

    - name: Build APK
      run: |
        cd android
        # Remove Capacitor's auto-generated ic_launcher_background.xml to avoid
        # duplicate resource conflict with the colour already in colors.xml
        rm -f app/src/main/res/values/ic_launcher_background.xml
        chmod +x gradlew
        ./gradlew assembleDebug

    - name: Rename APK
      run: |
        mv android/app/build/outputs/apk/debug/app-debug.apk android/app/build/outputs/apk/debug/kadaele-shopkeeper.apk

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: kadaele-shopkeeper
        path: android/app/build/outputs/apk/debug/kadaele-shopkeeper.apk
